------------------------------------------------------------------------

# Final report - Blank group

## Authors: Anders Mellbye, Juan Pablo López Cervantes, Guri Kringeland

#### Date: 2025-09-22
#### Output: html_document


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE, 
  message = FALSE
)

```


## Introduction
We were given two databases (main and additional) from the source: Cata et al. ’Blood Storage Duration and Biochemical Recurrence of Cancer after Radical Prostate ctomy’. Mayo Clin Proc 2011; 86(2): 120-127. A clean version is taken from R package medicaldata.

From the description available on the package website: “This data set contains data on 316 men who had undergone radical prostatectomy and received transfusion during or within 30 days of the surgical procedure and had available prostate serum antigen (PSA) follow-up data. The main exposure of interest was RBC storage duration group.”

We had different tasks to develop based on these databases and the new skills learned from R. In the following sections, we describe our work to fulfill these tasks. We hope you'll enjoy it.

---


## Tasks

## 1. Create an RStudio project and GitHub repository

We created our GitHub repository named "Blank exam" to place our documents. There you can find the README file with the overview of our directory.

## 2. Read and tidy the data set.

### First glance

We continued our journey learning about the most useful packages in the R world. We must admit these were first our worst enemies but ended up being friends and allies in this trip. Here an overview of those packages used throughout the course/project.


```{r message=FALSE, warning=FALSE,}

library(tidyverse)
library(readr)
library(here)
library(skimr)
library(forcats)
library(GGally)
```

Once we were able to understand a bit more about these packages, we started looking at our data. The original data set had 672 rows for 316 IDs and 21 variables. We identified several changes we needed to make on the data set so it could be readable and understandable. For example, we identified duplicated observations (40), some variable names that started either with numbers, spaces or signs: 1_Age. With spaces: T stage, volume measurement, and some variable names that were not so informative.

### Initial round of tidying the data

First we deleted 40 duplicates. Through the pivot wider task ( volumemasurement and .value-\> PVol and TVol). rows were halved, now presenting one row per ID for the 316 study subjects.

Then we tidyed the variables, by making new, more intuitive names fore those lacking of one. Columns containing information concerning two variables were either separated (Subject-\> Hospital and ID ) or split through pivot wider as mentioned. Columns listed in the assignmet as not of interest was deleted, as asked for in the task. Columns were then sorted with ID being placed first.

The coding was stored by the end of each session, with a script for the same date and a new data set after each session too (we present an overview of the different versions of our data throughout the tidying process).

First tidy version of the data set:

```{r message=FALSE, warning=FALSE, echo=FALSE}

tidy_exam_data <- read_delim(here("data", "tidy_exam_data_2025-09-08.txt"),
                             delim = "\t")
skimr::skim(tidy_exam_data)

```

## 3. Tidy, adjust, and explore.

### More tidying of the data

Further on we made new variables to filter and explore the dataset. For instance PVol_High as categorical variable ( \>/\< 100 ml) 
The variables unit_norm, ttr_num??? ??

Our dataset was left joined with the additional exam_data_joint.txt, by the common variable ID. By the end of the tidying session we ended up with 316 IDs( rows) and 27 variables (columns).

Afterwards, when looking over our variables, we needed to redo some of the steps:
   
   -We wanted to tidy the variable Hosp, deleting characters and keeping the number (1-3) of the treating hospital.

```
data_clean <- exam_data %>%
  separate(
    col = subject,
    into = c("Hosp", "ID"),
    sep = "-"
  )
data_clean

```

  -TimeToRecurrence_days_new, were made in the purpose of making the variable TimeToRecurrence_weeks_new, for calculations with the same numeric category (weeks). We met a little rocky road making this new variable, therefor keeping some duplicates to remember the steps of the string.


```
joint_exam_data <- read_tsv(here("data", "joint_exam_data_2025-09-09.txt")) %>%
  # New variabler
  mutate(
    unit_norm = str_to_lower(str_trim(TimeToRecurrence_unit)),
    ttr_num = parse_number(as.character(TimeToRecurrence)),
    TimeToRecurrence_days_new = case_when(
      str_starts(unit_norm, "week") ~ ttr_num * 7,
      str_starts(unit_norm, "day") ~ ttr_num,
      TRUE ~ NA_real_
    ),
    TimeToRecurrence_weeks_new = as.integer(round(TimeToRecurrence_days_new / 7, 0)),
    TimeToRecurrence_days_new = as.integer(round(TimeToRecurrence_days_new, 0)),
    Hospital = gsub("Hosp", "", Hosp)
  )


### This is to delete the old column - timetoreccurance_days ----
joint_exam_data <- joint_exam_data %>%
  select(-any_of(c("TimeToRecurrence_days", "timetoreccurance_days")))

# quick overview
glimpse(joint_exam_data)

```

Overview of the final tidy version and joining with the additional data set "exam_data.txt"):

```{r echo=FALSE, message=FALSE, warning=FALSE}

joint_exam_data <- read_delim(here("data", "joint_exam_data_2025-09-09.txt"),
                             delim = "\t")
skimr::skim(joint_exam_data)
```

Furthermore, we began exploring our variables in detail, based on the following instructions (we include the commands we used for each task):

1)  Stratify your data by a categorical column and report min, max, mean and sd of a numeric column.

```

joint_exam_data %>%
  group_by(Tumor_stage_lab = if_else(is.na(Tumor_stage), "Missing", as.character(Tumor_stage))) %>%
  summarise(
    n = n(),
    min = min(Preoperative_PSA, na.rm = TRUE),
    max = max(Preoperative_PSA, na.rm = TRUE),
    mean = mean(Preoperative_PSA, na.rm = TRUE),
    sd = sd(Preoperative_PSA, na.rm = TRUE),
    .groups = "drop"
  )

glimpse(joint_exam_data)
```

2)  Stratify your data by a categorical column and report min, max, mean and sd of a numeric column for a defined set of observations

-   Only for persons with `T.Stage == 1`

```

joint_exam_data %>%
  group_by(Recurrence2) %>%
  filter(Tumor_stage == 1) %>%
  summarise(
    min_pvol = min(PVol, na.rm = TRUE),
    max_pvol = max(PVol, na.rm = TRUE),
    mean_pvol = mean(PVol, na.rm = TRUE),
    sd_pvol = sd(PVol, na.rm = TRUE)
  )

```

-   Only for persons with `Median.RBC.Age == 25`

```

joint_exam_data %>%
  group_by(Recurrence2) %>%
  filter(Median_storage_age_group == 25) %>%
  summarise(
    min_pvol = min(PVol, na.rm = TRUE),
    max_pvol = max(PVol, na.rm = TRUE),
    mean_pvol = mean(PVol, na.rm = TRUE),
    sd_pvol = sd(PVol, na.rm = TRUE)
  )


```


-   Only for persons with `TimeToReccurence` later than 4 weeks

```

joint_exam_data %>%
  filter(TimeToRecurrence_weeks_new > 4) %>%
  group_by(Recurrence2) %>%
  summarise(
    min_pvol = min(PVol, na.rm = TRUE),
    max_pvol = max(PVol, na.rm = TRUE),
    mean_pvol = mean(PVol, na.rm = TRUE),
    sd_pvol = sd(PVol, na.rm = TRUE)
  )
glimpse(joint_exam_data)
```

-   Only for persons recruited in `Hospital 1` and `Tvol == 2`

```

joint_exam_data %>%
  filter(Hospital == "1", TVol == 2) %>%
  group_by(Recurrence2) %>%
  summarise(
    min_pvol = min(PVol, na.rm = TRUE),
    max_pvol = max(PVol, na.rm = TRUE),
    mean_pvol = mean(PVol, na.rm = TRUE),
    sd_pvol = sd(PVol, na.rm = TRUE)
  )

glimpse(joint_exam_data)

```


-   Use two categorical columns in your dataset to create a table (either with `table()`, `count()`, or `janitor::tabyl()`)

```
joint_exam_data %>%
  mutate(
    Tumor_stage = fct_explicit_na(as.factor(Tumor_stage), na_level = "Missing"),
    Hospital = as.factor(Hospital)
  ) %>%
  count(Tumor_stage, Hospital, name = "n", .drop = FALSE) %>%
  pivot_wider(names_from = Hospital, values_from = n, values_fill = 0)
```


After the latest tidying we and the stratifying work, we saved the dataset with the new name ggplot_exam_data, as getting ready for task 4 concerning ggplot.

```

fileName <- here("data", paste0("ggplot_exam_data_", Sys.Date(), ".txt"))
write_delim(
  joint_exam_data,
  file = fileName,
  delim = "\t"
)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot_exam_data <- read_delim(here("data", "ggplot_exam_data_2025-09-10.txt"),
                             delim = "\t")
skimr::skim(ggplot_exam_data)
```

Finally, we created a supplementary codebook based on the variables we created, changed and renamed.

```{r, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message= FALSE, results = "asis")
codebook <- file.path("..","data","Codebook_updated_2025_11_09.Rmd")
codebook <- normalizePath(codebook, winslash = "/", mustWork = TRUE)
cat(knitr::knit_child(codebook, quiet = TRUE))
```

## 4. Create plots

After a fun session on looking at how to create and format plots in R, we were able to create some nice figures (according to us) to try to answer the following questions. Before each figure, we included the script we used to build these plots according to each task (just for informative purposes).

1)  Are there any correlated measurements? (hint: `GGally::ggcorr` or search online for correlation matrix in R)

```         
library(dplyr)
library(GGally)
library(tidyverse)
library(ggcorrplot)

## Choosing solely numeric columns and filtrating columns that causes issues (missing N/A, or ID)
num <- ggplot_exam_data %>%
  select(where(is.numeric)) %>%
  select(-any_of(c("ID", "ttr_num", "TimeToRecurrence_weeks_new"))) %>%
  mutate(across(everything(), ~ ifelse(is.finite(.), ., NA_real_))) %>%
  select(where(~ sum(!is.na(.)) >= 3)) %>%
  select(where(~ sd(., na.rm = TRUE) > 0))

## Making a correlation matrix
cm <- cor(num, use = "pairwise.complete.obs", method = "pearson")

## Filtering
ok <- (rowSums(!is.finite(cm)) == 0) & (colSums(!is.finite(cm)) == 0)
cm_ok <- cm[ok, ok, drop = FALSE]

## Shorter labels
labs <- make.unique(abbreviate(colnames(cm_ok), minlength = 12))
colnames(cm_ok) <- rownames(cm_ok) <- labs

## Making the heatmap
plot_1 <- ggcorrplot(
  cm_ok,
  type = "lower",
  lab = FALSE,
  outline.col = "white",
  show.diag = TRUE,
  hc.order = TRUE
) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8),
    axis.text.y = element_text(size = 8)
  )

plot_1
```

##### **Figure 1**: Heatmap with correlation matrix

```{r pressure, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_1

```

ANSWER: Strong positive correlations are highlighted in red (close to +1), and strong negative correlations in blue (close to –1).In general, we see mildly correlated variables. We could highlight the positive stronger correlation between Recurrences, Time To Recurrence, Preoperative PSA, Tumor stage, TVol, and Preoperative and Adjuvant therapies. In addition, we could also point out to the negative correlation (close to -1) with regard to Censor and Time To Recurrence, Preoperative PSA, TVol, Preoperative and Adjuvant therapies.

2)  Is there a relation between the `PVol` and `TVol` variables?

```         
ggplot_exam_data2 <- ggplot_exam_data %>%
  select(PVol, TVol) %>%
  filter(!is.na(PVol), !is.na(TVol))

# Checking for correlation
spear <- cor.test(ggplot_exam_data2$PVol, ggplot_exam_data2$TVol, method = "spearman")

spear

# Setting up for the plot
dat <- read_tsv(here("data","ggplot_exam_data_2025-09-10.txt")) %>%
  select(PVol, TVol) %>%
  filter(is.finite(PVol), is.finite(TVol), PVol > 0) %>% # log10 trenger PVol > 0
  mutate(TVol = factor(TVol))

# Creating the boxplot and jitter
plot_2 <- ggplot(dat, aes(TVol, PVol)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.15, alpha = 0.5, size = 1) +
  scale_y_log10() +
  labs(
    title = "PVol by TVol",
    x = "TVol (category)",
    y = "PVol (log10 scale)"
  ) +
  theme_minimal()

plot_2

# Adding Spearman correlation to the boxplot
sp <- cor.test(dat$PVol, as.numeric(dat$TVol), method = "spearman")
plot_2a <- plot_2 + annotate("text",
  x = Inf, y = Inf,
  label = sprintf(
    "Spearman rho = %.2f, p = %.3g",
    sp$estimate, sp$p.value
  ),
  hjust = 1.05, vjust = 1.5, size = 4
)

plot_2a
```

##### **Figure 2**: Boxplot and Spearman correlation coefficient of the relation between Prostate Volumen (PVol) and Tumor Volume (TVol)

```{r pressure2, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))


plot_2a

```

ANSWER: This figure shows the distribution of prostate volume (PVol, log10 scale) across tumor volume (TVol) categories. Median PVol tends to be higher in men with lower TVol categories, with a gradual decline as TVol increases. The negative correlation is confirmed by a Spearman rank correlation coefficient of –0.21 (p = 0.0003), indicating that larger tumor volume is modestly but significantly associated with smaller prostate volume.

3)  Does the distribution of `PreopPSA` differ by `T.Stage`?

```         
plot_3 <- ggplot(ggplot_exam_data, aes(x = factor(Tumor_stage), y = Preoperative_PSA)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(
    title = "Distribution of Preoperative PSA by Tumor stage",
    x = "Tumor stage",
    y = "Preoperative PSA"
  ) +
  theme_minimal()
summary(ggplot_exam_data$Preoperative_PSA)
summary(ggplot_exam_data$Tumor_stage)

plot_3
```

##### **Figure 3**: Boxplot of the distribution of Preoperative Prostate Specific Antigen (PSA) across Tumor Stages

```{r pressure3, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_3

```

ANSWER: The distribution of preoperative PSA (PreopPSA) appears to differ by tumor stage. For instance, patients with stage 1 tumors had lower PSA values, though with several high outliers. Those with stage 2 tumors showed a broader spread and higher median PSA compared to stage 1, indicating more variability and higher levels overall. Overall, this suggests that higher tumor stage is associated with higher and more variable preoperative PSA levels.

4)  Does the distribution of `PVol` differ by `sGS`?

```         
plot_4 <- ggplot(ggplot_exam_data, aes(x = factor(sGS), y = PVol)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(
    title = "Distribution of Prostate Volume by Surgical Gleason score",
    x = "Surgical Gleason Score",
    y = "Prostate Volume"
  ) +
  theme_minimal()

plot_4
```

##### **Figure 4**: Boxplot of the distribution of Prostate volume across Surgical Gleason Score

```{r pressure4, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_4

```

ANSWER: Yes, we can see that the distribution of prostate volume differs by surgical Gleason score. While the medians don’t shift dramatically, the variability and number of outliers differ substantially. For instance, sGS = 2 has the broadest distribution with more very large prostate volumes, whereas sGS = 1 and 4 are tighter.

5)  Does the distribution of `TVol` differ by `sGS`?

```         
plot_5 <- ggplot(ggplot_exam_data, aes(x = factor(sGS), y = TVol)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(
    title = "Distribution of Tumor Volume by Surgical Gleason score",
    x = "Surgical Gleason Score",
    y = "Tumor Volume"
  ) +
  theme_minimal()

plot_5
```

##### **Figures 5 and 6**: Distribution of Tumor volume across Surgical Gleason Score

```{r pressure5, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_5

```

```         
plot_5b <- ggplot_exam_data %>%
  ggplot(aes(x = factor(TVol), fill = factor(sGS))) +
  geom_bar(position = "dodge") +
  labs(
    title = "Distribution of Tumor volume by Gleason score",
    x = "Tumor volume",
    y = "Number of patients",
    fill = "sGS (postoperative Gleason score)"
  ) +
  theme_minimal()

plot_5b
```

```{r pressure6, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_5b

```

ANSWER: We have included two graphs for this task in order to make it more understandable. In Figure 5, we can see that unlike prostate volume (PVol), the distribution of tumor volume (TVol) looks quite similar across sGS categories. There is no clear trend of increasing or decreasing tumor volume with higher Gleason scores. Figure 6 shows a clearer picture of the actual distribution of the patients, highlighting the differences across groups.

6)  Where there more `T.Stage == 2` in the group with `PreopTherapy == 1` than in the group `PreopTherapy == 0`?

```         
plot_6_1 <- ggplot_exam_data %>%
  mutate(Preoperative_therapy2 = if_else(Preoperative_therapy == "0", "No", "Yes")) %>%
  filter(Tumor_stage == 2) %>%
  ggplot(aes(Preoperative_therapy2)) +
  geom_bar(width = 0.3, fill = "darkblue")
plot_6_1

plot_6_2 <- plot_6_1 +
  xlab("Preoperative therapy") +
  ylab("Number of patients") +
  labs(
    title = "Number of patients with tumor stage 2",
    subtitle = "stratified by preoperative therapy groups"
  )

plot_6_2

plot_6 <- plot_6_2 +
  theme(
    plot.title = element_text(
      size = 20,
      face = "bold"
    )
  ) +
  theme_minimal()

plot_6
```

##### **Figure 7**: Distribution of patients with Tumor Stage 2, by preoperative therapy groups

```{r pressure7, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_6

```

ANSWER: There is a clear difference in the amount of patients with Tumor Stage 2 by Preoperative therapy, with more patients in the group that did not receive this therapy before the operation.

## 5. Analysing the data

After tidying, exploring, and making plots, we divided "task 5" exercises among the group, which regarded exercises on analyzing the data. Methods: Checked normality of time to recurrence (weeks) (Shapiro–Wilk + histogram) → non-normal → used Kruskal–Wallis for group comparisons. Furthermore, we compared time to recurrence across RBC storage age groups and tumor stage. Then we ran two simple linear models: TimeToRecurrence_days_new \~ Adjuvant_radiation_therapy; & TVol \~ Recurrence. (Effect sizes and p-values reported in script output tables.)

RESULTS: RBC storage age groups: Kruskal–Wallis χ²(2)=1.022, p=0.60 → no evidence of differences. Tumor stage: Kruskal–Wallis χ²(1)=7.962, p=0.0048 → distributions differ by stage. Linear models showed: Therapy–time and Recurrence–TVol associations summarized by coefficients; see script tables for estimates and significance.

CONCLUSIONS: No difference by RBC storage age; clear difference by tumor stage; AdjRadTherapy and time to recurrence showed no significant association; Recurrence and TVol: Yes—patients with recurrence had significantly larger TVol.

We also did a minor change in the dataset through renaming the sGS column to Surgical_gleason_score for tidying purposes.

See the full analysis script here: [Script_sixthday_2025-11-09.R](blank//scripts/Script_sixthday_2025-11-09.R)

```{r include=FALSE}

```
