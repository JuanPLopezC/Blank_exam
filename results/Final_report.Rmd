------------------------------------------------------------------------

Title: "Final Report - Blank group" author: "AndersM, Juan Pablo López C, Guri Kringeland " ======= Title: "Final report" authors: 'Anders Mellbye, Juan Pablo López Cervantes, Guri Kringeland '

date: "2025-09-11" output: pdf_document: default html_document: default editor_options: markdown: wrap: 72 ---

tinytex::install_tinytex()

# INTRODUCTION

We were given two databases (main and additional) from the source: Cata et al. ’Blood Storage Duration and Biochemical Recurrence of Cancer after Radical Prostate ctomy’. Mayo Clin Proc 2011; 86(2): 120-127. A clean version is taken from R package medicaldata.

From the description available on the package website: “This data set contains data on 316 men who had undergone radical prostatectomy and received transfusion during or within 30 days of the surgical procedure and had available prostate serum antigen (PSA) follow-up data. The main exposure of interest was RBC storage duration group.”

We had different tasks to develop based on these database and the new skills learned from R. In the following sections, we describe our work to fulfill these tasks. We hope you enjoy it.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Create an RStudio project and GitHub repository

We created our GitHub repository named "Blank exam" to place our documents. There you can find the README file with the overview of our directory.

## 2. Read and tidy the data set.

### First glance

The original data set had 672 rows for 316 IDs and 21 variables..

### Initial round of tidying the data

First we deleted 40 duplicates. Through the pivot wider task ( volumemasurement and .value-\> PVol and TVol). rows were halved, now presenting one row per ID for the 316 study subjects.

Then we tidyed the variables, by making new, more intuitive names fore those lacking of one. Columns containing information concerning two variables were either separated (Subject-\> Hospital and ID ) or splitt through pivot wider as mentioned. Columns listed in the assignmet as not of interest was deleted, as asked for in the task. Columns were then sorted with ID first.

Further on we made new variables to filter and explore the datasett. For instance PVol_High as categorical varible ( \>/\< 100 ml) The variables unit_norm, ttr_num, TimeToRecurrence_days_new, were all made in the purpose of making the variable TimeToRecurrence_weeks_new, for calculations with the same numeric category (weeks). We met a little rocky road making this new variable, therefor keeping some duplicates to remember the steps of the string.

The coding was stored by the end of each session, with a script for the same date and a new data set after each session too (we present an overview of the different versions of our data througout the tidying process). 

First tidy version of the data set:
```{r message=FALSE, warning=FALSE, echo=FALSE}

library(here)
library(readr)

tidy_exam_data <- read_delim(here("data", "tidy_exam_data_2025-09-08.txt"),
                             delim = "\t")
skimr::skim(tidy_exam_data)

```

## 3. Tidy, adjust, and explore.

### More tidying of the data

We continued tidying our data set...

Second tidy version:
```{r message=FALSE, warning=FALSE, echo=FALSE}

library(here)
library(readr)

tidy_exam_data2 <- read_delim(here("data", "tidy_exam_data_2025-09-09.txt"),
                             delim = "\t")
skimr::skim(tidy_exam_data2)

```

Our datasett was then joined by the additional exam_data_joint.txt, by the common variable ID. By the end of the tidying session we ended up with 316 IDs( rows) and 27 variables (columns).

Overview of the final tidy version (after joining it with the additional data set "exam_data.txt"):
```{r message=FALSE, warning=FALSE, echo=FALSE}

library(here)
library(readr)

joint_exam_data <- read_delim(here("data", "joint_exam_data_2025-09-09.txt"),
                             delim = "\t")
skimr::skim(joint_exam_data)

```

Once we had joint the two data sets we were given, we began exploring in detail our variables, based on the following instructions...

Stratify your data by a categorical column and report min, max, mean and sd of a numeric column. - Stratify your data by a categorical column and report min, max, mean and sd of a numeric column for a defined set of observations - use a pipe `%>%`!\
*(each member of the group chooses one column)* - Only for persons with `T.Stage == 1` - Only for persons with `Median.RBC.Age == 25` - Only for persons with `TimeToReccurence` later than 4 weeks - Only for persons recruited in `Hosp1` and `Tvol == 2` - Use two categorical columns in your dataset to create a table (either with `table()`, `count()`, or `janitor::tabyl()`)

list.files("scripts")


Finally, we updated the codebook after we renamed and deleted variables in the tidying process. OBS! This is not looking nice, not the html version nor the .txt, I do not know if there is a way of fixing the new codebook so it could look more like the original one?

You can just skip this part, i put this to convert the .txt to html and open it in the .rmd every time, but i think we need to format the codebook first.


```{r, include=FALSE}
library(rmarkdown)

# Paths
codebook_txt  <- here::here("data", "Codebook_updated_2025_11_09.txt")
codebook_html <- here::here("data", "Codebook_updated_2025_11_09.html")

# Convert .txt → .html if needed
if (file.exists(codebook_txt)) {
  rmarkdown::pandoc_convert(
    input   = codebook_txt,
    to      = "html",
    output  = codebook_html,
    options = c("--standalone")
  )
}
```

```{r, results='asis', echo=FALSE}
htmltools::includeHTML(here::here("data", "Codebook_updated_2025_11_09.html"))
```




## 4. Create plots

After a fun session looking at how to create and format plots in R, we were able to create some nice figures (according to us) to try to answer the following questions. Here we show part of the script we used to build these figures according to each task.

1)  Are there any correlated measurements? (hint: `GGally::ggcorr` or search online for correlation matrix in R)

```         
library(readr)
library(dplyr)
library(GGally)
library(tidyverse)
library(ggcorrplot)
library(here)

## Choosing solely numeric columns and filtrating columns that causes issues (missing N/A, or ID)
num <- ggplot_exam_data %>%
  select(where(is.numeric)) %>%
  select(-any_of(c("ID", "ttr_num", "TimeToRecurrence_weeks_new"))) %>%
  mutate(across(everything(), ~ ifelse(is.finite(.), ., NA_real_))) %>%
  select(where(~ sum(!is.na(.)) >= 3)) %>%
  select(where(~ sd(., na.rm = TRUE) > 0))

## Making a correlation matrix
cm <- cor(num, use = "pairwise.complete.obs", method = "pearson")

## Filtering
ok <- (rowSums(!is.finite(cm)) == 0) & (colSums(!is.finite(cm)) == 0)
cm_ok <- cm[ok, ok, drop = FALSE]

## Shorter labels
labs <- make.unique(abbreviate(colnames(cm_ok), minlength = 12))
colnames(cm_ok) <- rownames(cm_ok) <- labs

## Making the heatmap
plot_1 <- ggcorrplot(
  cm_ok,
  type = "lower",
  lab = FALSE,
  outline.col = "white",
  show.diag = TRUE,
  hc.order = TRUE
) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8),
    axis.text.y = element_text(size = 8)
  )

plot_1
```

```{r pressure, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_1

```
ANSWER: Strong positive correlations are highlighted in red (close to +1), and strong negative correlations in blue (close to –1).In general, we see mildly correlated variables. We could highlight the positive stronger correlation between Recurrences, Time To Recurrence, Preoperative PSA, Tumor stage, TVol, and Preoperative and Adjuvant therapies. In addition, we could also point out to the negative correlation (close to -1.0) with regard to Censor and Time To Recurrence, Preoperative PSA, TVol, Preoperative and Adjuvant therapies.

2)  Is there a relation between the `PVol` and `TVol` variables?

```   
ggplot_exam_data2 <- ggplot_exam_data %>%
  select(PVol, TVol) %>%
  filter(!is.na(PVol), !is.na(TVol))

# Checking for correlation
spear <- cor.test(ggplot_exam_data2$PVol, ggplot_exam_data2$TVol, method = "spearman")

spear

# Setting up for the plot
dat <- read_tsv(here("data","ggplot_exam_data_2025-09-10.txt")) %>%
  select(PVol, TVol) %>%
  filter(is.finite(PVol), is.finite(TVol), PVol > 0) %>% # log10 trenger PVol > 0
  mutate(TVol = factor(TVol))

# Creating the boxplot and jitter
plot_2 <- ggplot(dat, aes(TVol, PVol)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.15, alpha = 0.5, size = 1) +
  scale_y_log10() +
  labs(
    title = "PVol by TVol",
    x = "TVol (category)",
    y = "PVol (log10 scale)"
  ) +
  theme_minimal()

plot_2

# Adding Spearman correlation to the boxplot
sp <- cor.test(dat$PVol, as.numeric(dat$TVol), method = "spearman")
plot_2a <- plot_2 + annotate("text",
  x = Inf, y = Inf,
  label = sprintf(
    "Spearman rho = %.2f, p = %.3g",
    sp$estimate, sp$p.value
  ),
  hjust = 1.05, vjust = 1.5, size = 4
)

plot_2a
```
```{r pressure2, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_2
plot_2a

```

3)  Does the distribution of `PreopPSA` differ by `T.Stage`?


```   
plot_3 <- ggplot(ggplot_exam_data, aes(x = factor(Tumor_stage), y = Preoperative_PSA)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(
    title = "Distribution of Preoperative PSA by Tumor stage",
    x = "Tumor stage",
    y = "Preoperative PSA"
  ) +
  theme_minimal()
summary(ggplot_exam_data$Preoperative_PSA)
summary(ggplot_exam_data$Tumor_stage)

plot_3
```
```{r pressure3, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_3

```

4)  Does the distribution of `PVol` differ by `sGS`?

```   
plot_4 <- ggplot(ggplot_exam_data, aes(x = factor(sGS), y = PVol)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(
    title = "Distribution of Protate Volume by surgical Gleason score",
    x = "Surgical Gleason Score",
    y = "Prostate Volume"
  ) +
  theme_minimal()

plot_4
```
```{r pressure4, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_4

```

5)  Does the distribution of `TVol` differ by `sGS`?

```   
plot_5 <- ggplot(ggplot_exam_data, aes(x = factor(sGS), y = TVol)) +
  geom_boxplot(fill = "lightblue", color = "darkblue") +
  labs(
    title = "Distribution of Tumor Volume by surgical Gleason score",
    x = "Surgical Gleason Score",
    y = "Tumor Volume"
  ) +
  theme_minimal()

plot_5
```
```{r pressure5, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_5

```

```   
plot_5b <- ggplot_exam_data %>%
  ggplot(aes(x = factor(TVol), fill = factor(sGS))) +
  geom_bar(position = "dodge") +
  labs(
    title = "Distribution of Tumor volume by Gleason score",
    x = "Tumor volume",
    y = "Number of patients",
    fill = "sGS (postoperative Gleason score)"
  ) +
  theme_minimal()

plot_5b
```
```{r pressure6, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_5b

```


6)  Where there more `T.Stage == 2` in the group with `PreopTherapy == 1` than in the group `PreopTherapy == 0`?

```   
plot_6_1 <- ggplot_exam_data %>%
  mutate(Preoperative_therapy2 = if_else(Preoperative_therapy == "0", "No", "Yes")) %>%
  filter(Tumor_stage == 2) %>%
  ggplot(aes(Preoperative_therapy2)) +
  geom_bar(width = 0.3, fill = "darkblue")
plot_6_1

plot_6_2 <- plot_6_1 +
  xlab("Preoperative therapy") +
  ylab("Number of patients") +
  labs(
    title = "Number of patients with tumor stage 2",
    subtitle = "stratified by preoperative therapy groups"
  )

plot_6_2

plot_6 <- plot_6_2 +
  theme(
    plot.title = element_text(
      size = 20,
      face = "bold"
    )
  ) +
  theme_minimal()

plot_6
```
```{r pressure7, echo=FALSE, warning=FALSE, message=FALSE}
source(here("scripts", "Script_ggplot_2025-10-09.R"))

plot_6

```


## 5. Analysing the data

After tidying, exploring, and making plots, we divided "task 5" exercises among the group, which regarded exercises on analyzing the data. Methods: Checked normality of time to recurrence (weeks) (Shapiro–Wilk + histogram) → non-normal → used Kruskal–Wallis for group comparisons. Furthermore, we compared time to recurrence across RBC storage age groups and tumor stage. Then we ran two simple linear models: TimeToRecurrence_days_new \~ Adjuvant_radiation_therapy; & TVol \~ Recurrence. (Effect sizes and p-values reported in script output tables.)

Results:RBC storage age groups: Kruskal–Wallis χ²(2)=1.022, p=0.60 → no evidence of differences. Tumor stage: Kruskal–Wallis χ²(1)=7.962, p=0.0048 → distributions differ by stage. Linear models showed: Therapy–time and Recurrence–TVol associations summarized by coefficients; see script tables for estimates and significance.

Conclusions: No difference by RBC storage age; clear difference by tumor stage; AdjRadTherapy and time to recurrence showed no significant association; Recurrence and TVol: Yes—patients with recurrence had significantly larger TVol.

We also did a minor change in the dataset trough renaming the sGS column to Surgical_gleason_score for tidying purposes.

See the full analysis script here: [Script_sixthday_2025-11-09.R](blank//scripts/Script_sithday_2025-11-09.R)

```{r include=FALSE}

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
